@page "/"

@attribute [Authorize]

@using Community.Blazor.MapLibre
@using Community.Blazor.MapLibre.Models
@using Community.Blazor.MapLibre.Models.Control
@using Community.Blazor.MapLibre.Models.Marker

@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.SignalR.Client

@using Pariqas.Models
@using Pariqas.Models.Devices
@using Pariqas.Web.Services
@using Pariqas.Web.Components

@inject HttpClient Http
@inject TokenService TokenService

<PageTitle>Home</PageTitle>

<div class="row g-0">
    <div class="col-0 col-sm-3 col-md-2">
        @if (devices is null || devices.Count == 0)
        {
            <div class="d-flex align-items-center justify-content-center h-100">
                <Spinner />
            </div>
        }
        else
        {
            <div class="row gy-2 p-2">
                @foreach (var device in devices)
                {
                    <div class="col-12">
                        <DeviceCard Device="device"></DeviceCard>
                    </div>
                }
            </div>
        }
    </div>
    
    <div class="col-12 col-sm-9 col-md-10">
        <MapLibre @ref="map" Options="options" Class="w-100 vh-100" OnLoad="OnMapInitializedAsync"/>
    </div>
</div>

@code
{
    private MapLibre map = new MapLibre();
    private MapOptions options = new MapOptions
    {
        MaxZoom = 23,
        MinZoom = 2,
        Zoom = 2,
        Style = "style.json",
        CanvasContextAttributes = new WebGLContextAttributes
        {
            Antialias = true,
            ContextType = "webgl2"
        }
    };

    private HubConnection connection;
    private List<Device> devices;
    private MarkerService MarkerService => new MarkerService(map);

    protected override async Task OnInitializedAsync()
    {
        devices = await Http.GetFromJsonAsync<List<Device>>("https://pariqas.onrender.com/devices");
        connection = new HubConnectionBuilder()
            .WithUrl("https://pariqas.onrender.com/hubs/location", options =>
            {
                options.AccessTokenProvider = async () => await TokenService.GetTokenAsync();
            })
            .WithAutomaticReconnect()
            .Build();

        connection.On<string, Location>(EventNames.LocationUpdate, OnLocationUpdateAsync);
        
        await connection.StartAsync();
    }

    private async Task OnMapInitializedAsync(EventArgs arg)
    {
        foreach (var device in devices)
        {
            string image = device.Type switch
            {
                DeviceType.Computer => "computer.png",
                DeviceType.Phone => "smartphone.png",
                _ => throw new ArgumentOutOfRangeException()
            };
            
            await MarkerService.AddMarkerAsync(device.Id, device.Location, new MarkerOptions
            {
                OpacityWhenCovered = "0",
                Extensions = new MarkerOptionsExtensions
                {
                    HtmlContent = $"""<div class="d-flex justify-content-center align-items-center rounded-circle border border-2 border-light-subtle bg-white" style="width: 50px; height: 50px;"><img src="/images/{image}" class="rounded-circle" style="width: 32px; height: 32px;"></div>"""
                }
            });
        }

        await map.AddControl(ControlType.NavigationControl, ControlPosition.TopRight);
        await map.AddControl(ControlType.GlobeControl, ControlPosition.TopRight);
        await map.AddControl(ControlType.GeolocateControl, ControlPosition.TopRight);
    }

    private async Task OnLocationUpdateAsync(string id, Location location)
    {
        await MarkerService.MoveMarkerAsync(id, location);
    }
}